#!/bin/bash

####################################################################################################
#### author: SlickStack ############################################################################
#### link: https://slickstack.io ###################################################################
#### mirror: http://mirrors.slickstack.io/ss-update.txt ############################################
#### path: /var/www/ss-update ######################################################################
#### destination: n/a (not a boilerplate) ##########################################################
#### purpose: Updates and cleans up SlickStack modules (Ubuntu packages) and WP extensions #########
#### module version: Ubuntu 18.04 LTS ##############################################################
####################################################################################################

## YOU CAN SAFELY RUN SS-UPDATE WITH NO EFFECT TO YOUR SLICKSTACK CONFIGURATION ##

## include SlickStack configuration ##
source /var/www/ss-config

## critical functions (aliases) for this script to function ##
# apt () { command DEBIAN_FRONTEND=noninteractive DEBIAN_PRIORITY=critical PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' /usr/bin/apt -q --yes -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" "$@"; }
apt () { DEBIAN_FRONTEND=noninteractive DEBIAN_PRIORITY=critical PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' 
            command /usr/bin/apt -q --yes -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" "$@";
       }
wget () { command wget --no-check-certificate --no-cache --no-cookies --tries=3 --timeout=15 "$@"; }
cp () { command cp -R -f -d --no-preserve=mode,ownership "$@"; }
rm () { command rm -R -f "$@"; }
mkdir () { command mkdir -p "$@"; }
unzip () { command unzip -o "$@"; }

####################################################################################################
#### SS-Update: Backup Live MySQL Database Before Proceeding (Via SS-Dump) #########################
####################################################################################################

## run ss-dump ##
source /var/www/ss-dump

####################################################################################################
#### SS-Update: Update MU (Must-Use) Plugins (Via SS-Muplugs) ######################################
####################################################################################################

## run ss-muplugs ##
source /var/www/ss-muplugs

####################################################################################################
#### SS-Update: Upgrade + Autoremove + Autoclean SlickStack Modules (Ubuntu Packages) ##############
####################################################################################################

## update Ubuntu repo cache ##
apt update

## upgrade installed Ubuntu packages (SlickStack LEMP modules) ##
apt upgrade

## autoremove Ubuntu packages ##
apt autoremove

## autoclean Ubuntu packages ##
apt autoclean

####################################################################################################
#### SS-Update: Purge All Caches (Via SS-Purge) ####################################################
####################################################################################################

## run ss-purge ##
source /var/www/ss-purge

####################################################################################################
#### SS-Update: Restart All Services (Via SS-Restart) ##############################################
####################################################################################################

## run ss-restart ##
source /var/www/ss-restart

####################################################################################################
#### SS-Update: Reboot Server Automatically (Optional In SS-Config) ################################
####################################################################################################

## IT IS ALWAYS BETTER TO RUN SS-UPDATE MANUALLY AND REBOOT YOUR SERVER MANUALLY ##

if [[ "$SS_REBOOT" == "true" ]]; then 
    echo -e "\e[93mSlickStack updates complete! Automatic server reboot in progress... see you on the other side!\e[0m" >&2
    /bin/bash -c "/sbin/reboot"
else 
    echo -e "\e[36mSlickStack updates complete! Please reboot server using sudo reboot command.\e[0m"
fi

####################################################################################################
#### External References Used By SlickStack To Improve This Script #################################
####################################################################################################

## Ref: https://unix.stackexchange.com/questions/467552/reboot-over-ssh/467996#467996
