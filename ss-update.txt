#!/bin/bash

####################################################################################################
#### author: SlickStack ############################################################################
#### link: https://slickstack.io ###################################################################
#### mirror: http://mirrors.slickstack.io/ss-update.txt ############################################
#### path: /var/www/ss-update ######################################################################
#### destination: n/a (not a boilerplate) ##########################################################
#### purpose: Updates and cleans up SlickStack modules (Ubuntu packages) and WP extensions #########
#### module version: Ubuntu 18.04 LTS ##############################################################
####################################################################################################

## YOU CAN SAFELY RUN SS-UPDATE WITH NO EFFECT TO YOUR SLICKSTACK CONFIGURATION ##

## include SlickStack configuration ##
source /var/www/ss-config

####################################################################################################
#### SlickStack: Critical Bash Functions (Aliases) For This Script To Work #########################
####################################################################################################

## apt alias flags ##
function apt {
    export DEBIAN_FRONTEND=noninteractive
    export DEBIAN_PRIORITY=critical
    export PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
    command /usr/bin/apt -q -y -o Dpkg::Options::=--force-confold -o Dpkg::Options::=--force-confdef "$@"
}

## add-apt-repository alias flags ##
function add-apt-repository {
    export DEBIAN_FRONTEND=noninteractive
    export DEBIAN_PRIORITY=critical
    export PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
    command /usr/bin/add-apt-repository -y "$@"
}

## wget alias flags ##
function wget {
    command wget --no-check-certificate --no-cache --no-cookies --tries=3 --timeout=15 "$@"
}

## cp alias flags ##
function cp {
    command cp -R -f -d --no-preserve=mode,ownership "$@"
}

## mkdir alias flags ##
function mkdir {
    command mkdir -p "$@"
}

## unzip alias flags ##
function unzip {
    command unzip -o "$@"
}

## rm alias flags ##
function rm {
    command rm -R -f "$@"
}

## ln alias flags ##
function ln {
    command ln -s -f "$@"
}

####################################################################################################
#### SS-Update: Backup MySQL Database Before Proceeding (Via SS-Dump) ##############################
####################################################################################################

## run ss-dump ##
source /var/www/ss-dump

####################################################################################################
#### SS-Update: Install Latest SS-Config File (Safely Replicates Existing Settings) ################
####################################################################################################

## MODULE VERSION: SS Build = DEC2019E

## delete leftover files ##
rm /tmp/ss-config*

## retrieve latest version of ss-config-sample ##
wget -O /tmp/ss-config http://mirrors.slickstack.io/ss-config-sample.txt

## replicate existing variables to the new config file ##
## find a better way to auto detect variables? ##
sed -i "s|\(^ROOT_PASSWORD=\).*|ROOT_PASSWORD=\"$ROOT_PASSWORD\"|g" /tmp/ss-config
sed -i "s|\(^SUDO_USER=\).*|SUDO_USER=\"$SUDO_USER\"|g" /tmp/ss-config
sed -i "s|\(^SUDO_PASSWORD=\).*|SUDO_PASSWORD=\"$SUDO_PASSWORD\"|g" /tmp/ss-config
sed -i "s|\(^SSH_PORT=\).*|SSH_PORT=\"$SSH_PORT\"|g" /tmp/ss-config
sed -i "s|\(^SFTP_USER=\).*|SFTP_USER=\"$SFTP_USER\"|g" /tmp/ss-config
sed -i "s|\(^SFTP_PASSWORD=\).*|SFTP_PASSWORD=\"$SFTP_PASSWORD\"|g" /tmp/ss-config
sed -i "s|\(^DB_NAME=\).*|DB_NAME=\"$DB_NAME\"|g" /tmp/ss-config
sed -i "s|\(^DB_USER=\).*|DB_USER=\"$DB_USER\"|g" /tmp/ss-config
sed -i "s|\(^DB_PASSWORD=\).*|DB_PASSWORD=\"$DB_PASSWORD\"|g" /tmp/ss-config
sed -i "s|\(^DB_PASSWORD_ROOT=\).*|DB_PASSWORD_ROOT=\"$DB_PASSWORD_ROOT\"|g" /tmp/ss-config
sed -i "s|\(^DB_HOST=\).*|DB_HOST=\"$DB_HOST\"|g" /tmp/ss-config
sed -i "s|\(^DB_PREFIX=\).*|DB_PREFIX=\"$DB_PREFIX\"|g" /tmp/ss-config
sed -i "s|\(^DB_CHARSET=\).*|DB_CHARSET=\"$DB_CHARSET\"|g" /tmp/ss-config
sed -i "s|\(^DB_COLLATE=\).*|DB_COLLATE=\"$DB_COLLATE\"|g" /tmp/ss-config
sed -i "s|\(^SITE_TLD=\).*|SITE_TLD=\"$SITE_TLD\"|g" /tmp/ss-config
sed -i "s|\(^SITE_DOMAIN=\).*|SITE_DOMAIN=\"$SITE_DOMAIN\"|g" /tmp/ss-config
sed -i "s|\(^SITE_NOINDEX=\).*|SITE_NOINDEX=\"$SITE_NOINDEX\"|g" /tmp/ss-config
sed -i "s|\(^CLOUDFLARE_API_KEY=\).*|CLOUDFLARE_API_KEY=\"$CLOUDFLARE_API_KEY\"|g" /tmp/ss-config
sed -i "s|\(^CLOUDFLARE_API_EMAIL=\).*|CLOUDFLARE_API_EMAIL=\"$CLOUDFLARE_API_EMAIL\"|g" /tmp/ss-config
sed -i "s|\(^CLOUDFLARE_WIDGET_DNS=\).*|CLOUDFLARE_WIDGET_DNS=\"$CLOUDFLARE_WIDGET_DNS\"|g" /tmp/ss-config
sed -i "s|\(^CLOUDFLARE_WIDGET_ANALYTICS=\).*|CLOUDFLARE_WIDGET_ANALYTICS=\"$CLOUDFLARE_WIDGET_ANALYTICS\"|g" /tmp/ss-config
sed -i "s|\(^CLOUDFLARE_RECOMMENDED_SETTINGS=\).*|CLOUDFLARE_RECOMMENDED_SETTINGS=\"$CLOUDFLARE_RECOMMENDED_SETTINGS\"|g" /tmp/ss-config

## copy files to destinations ##
cp /tmp/ss-config /var/www/ss-config

## reset permissions ##
chown root:root /var/www/ss-config &> /dev/null ## must be root:root
chmod 0700 /var/www/ss-config &> /dev/null

## delete leftover files ##
rm /tmp/ss-config*

####################################################################################################
#### SS-Update: Update MU (Must-Use) Plugins (Via SS-Muplugs) ######################################
####################################################################################################

## run ss-muplugs ##
source /var/www/ss-muplugs

####################################################################################################
#### SS-Update: Upgrade + Autoremove + Autoclean SlickStack Modules (Ubuntu Packages) ##############
####################################################################################################

## set confold as the dpkg default choice ##
DEBIAN_FRONTEND=noninteractive dpkg --configure -a --force-confold

## update Ubuntu repo cache ##
apt update

## upgrade installed Ubuntu packages (LEMP modules) + Linux kernel (apt feature) ##
apt full-upgrade

## autoremove unused Ubuntu packages ##
apt autoremove

## autoclean Ubuntu packages ##
apt autoclean

####################################################################################################
#### SS-Update: Purge All Caches (Via SS-Purge) ####################################################
####################################################################################################

## run ss-purge ##
source /var/www/ss-purge

####################################################################################################
#### SS-Update: Restart All Services (Via SS-Restart) ##############################################
####################################################################################################

## run ss-restart ##
source /var/www/ss-restart

####################################################################################################
#### SS-Update: Reboot Server Automatically (Optional In SS-Config) ################################
####################################################################################################

## IT IS ALWAYS BETTER TO RUN SS-UPDATE MANUALLY AND REBOOT YOUR SERVER MANUALLY ##

## reboot server ##
if [[ "$SS_REBOOT" == "true" ]]; then 
    echo -e "\e[93mSlickStack updates complete! Automatic server reboot in progress... see you on the other side!\e[0m" >&2
    /bin/bash -c "/sbin/reboot"
else 
    echo -e "\e[36mSlickStack updates complete! Please reboot server using sudo reboot.\e[0m"
fi

####################################################################################################
#### SlickStack: External References Used To Improve This Script (Thanks, Interwebz) ###############
####################################################################################################

## Ref: https://linux.die.net/man/8/apt-get
## Ref: https://askubuntu.com/questions/1112555/is-apt-dist-upgrade-not-necessary-anymore
## Ref: https://unix.stackexchange.com/questions/467552/reboot-over-ssh/467996#467996
## Ref: https://askubuntu.com/questions/254129/how-to-display-all-apt-get-dpkgoptions-and-their-current-values
## Ref: https://serverfault.com/questions/48724/100-non-interactive-debian-dist-upgrade
## Ref: https://askubuntu.com/questions/938359/apt-get-install-remove-update-upgrade-via-cron-job
## Ref: http://manpages.ubuntu.com/manpages/trusty/man8/apt.8.html
## Ref: https://www.debian.org/doc/manuals/apt-guide/index.en.html
## Ref: https://serverfault.com/questions/478461/how-to-install-packages-with-apt-without-user-interaction
## Ref: https://serverfault.com/questions/644180/what-does-qq-argument-for-apt-get-mean
## Ref: https://superuser.com/questions/1438031/ubuntu-18-command-apt-get-dist-upgrade-qq-force-yes-deprecated
## Ref: https://superuser.com/questions/1412054/non-interactive-apt-upgrade
## Ref: https://serverfault.com/questions/227190/how-do-i-ask-apt-get-to-skip-any-interactive-post-install-configuration-steps
## Ref: https://bugzilla.redhat.com/show_bug.cgi?id=1253351
## Ref: https://kb.cloudberrylab.com/backup-mac-linux/silent-install-macos-and-linux-builds
## Ref: https://unix.stackexchange.com/questions/32533/debian-how-to-delay-configuration-when-installing-upgrading
## Ref: https://raymii.org/s/tutorials/Silent-automatic-apt-get-upgrade.html
## Ref: https://unix.stackexchange.com/questions/138504/setting-path-vs-exporting-path-in-bash-profile
## Ref: https://askubuntu.com/questions/578568/path-error-in-ubuntu
## Ref: https://stackoverflow.com/questions/38977713/what-is-snap-bin-directory-in-path-can-i-remove-it-from-path
## Ref: https://askubuntu.com/questions/1121495/add-snap-bin-to-path-used-by-systemd
## Ref: https://askubuntu.com/questions/163200/e-dpkg-was-interrupted-run-sudo-dpkg-configure-a
## Ref: https://stackoverflow.com/questions/1305237/how-to-list-variables-declared-in-script-in-bash
## Ref: https://stackoverflow.com/questions/32739572/bash-search-and-replace-value-of-a-variable-inside-a-file
## Ref: https://askubuntu.com/questions/76808/how-do-i-use-variables-in-a-sed-command
## Ref: https://unix.stackexchange.com/questions/69112/how-can-i-use-variables-in-the-lhs-and-rhs-of-a-sed-substitution
## Ref: https://stackoverflow.com/questions/19151954/how-to-use-variables-in-a-command-in-sed
