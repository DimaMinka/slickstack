#!/bin/bash

####################################################################################################
#### author: SlickStack ############################################################################
#### link: https://slickstack.io ###################################################################
#### mirror: http://mirrors.slickstack.io/ss-worker.txt ############################################
#### path: /var/www/ss-worker ######################################################################
#### destination: n/a (not a boilerplate) ##########################################################
#### purpose: performs various maintenance tasks and downloads latest ss-check file ################
#### ss version: SlickStack alpha ss5a #############################################################
#### module version: n/a ###########################################################################
####################################################################################################

## include SlickStack configuration ##
source /var/www/ss-config

####################################################################################################
#### delete any previous / leftover temporary files ################################################
####################################################################################################

rm -R -f /tmp/*cron*
rm -R -f /tmp/ss*
rm -R -f /tmp/blacklist*

####################################################################################################
#### update ss-check and 1-cron-often files to latest version ######################################
####################################################################################################

# download latest versions ##
wget --no-cache --no-cookies -O /tmp/1-cron-often.txt http://mirrors.slickstack.io/1-cron-often.txt
wget --no-cache --no-cookies -O /tmp/ss-check.txt http://mirrors.slickstack.io/ss-check.txt

## rename files ##
mv /tmp/1-cron-often.txt /tmp/1-cron-often
mv /tmp/ss-check.txt /tmp/ss-check

## copy files to /var/www/ ##
cp -R -f -d --no-preserve=mode,ownership /tmp/1-cron-often /var/www/1-cron-often
cp -R -f -d --no-preserve=mode,ownership /tmp/ss-check /var/www/ss-check

####################################################################################################
#### reset permissions #############################################################################
####################################################################################################

chown root:root /var/www/*cron*
chown root:root /var/www/ss*
chmod 700 /var/www/*cron*
chmod 700 /var/www/ss*

####################################################################################################
## update blacklist.txt file to latest version for Plugin Blacklist (MU plugin) ####################
####################################################################################################

## download and replace latest blacklist.txt file ##
wget --no-cache --no-cookies -O /tmp/blacklist.txt http://mirrors.slickstack.io/wordpress/blacklist.txt
cp -R -f -d --no-preserve=mode,ownership /tmp/blacklist.txt /var/www/html/wp-content/blacklist.txt

## download and replace latest blacklist.txt file ##
# wget --no-check-certificate --no-cache --no-cookies -O /tmp/blacklist.txt @PLUGIN_BLACKLIST_SOURCE
# cp -R -f -d --no-preserve=mode,ownership /tmp/blacklist.txt /var/www/html/wp-content/blacklist.txt

## reset permissions ##
chown www-data:wordpress /var/www/html/wp-content/blacklist.txt
chmod 664 /var/www/html/wp-content/blacklist.txt

####################################################################################################
#### delete any previous / leftover temporary files ################################################
####################################################################################################

rm -R -f /tmp/*cron*
rm -R -f /tmp/ss*
rm -R -f /tmp/blacklist*

####################################################################################################
#### various TEMPORARY tasks (custom Bash commands, etc) ###########################################
####################################################################################################

## uncomment for approximately ~45 minutes for urgent MU plugins updates ##
# source /var/www/ss-muplugs

## change error log path (sed replace example) ##
# sed -i '/error_log/c\error_log = /var/www/logs/error.log' /etc/php/7.2/fpm/php-fpm.conf
# sed -i "s#/var/log/php-fpm/error.log#/var/www/logs/error.log#g" /var/www/html/wp-config.php
