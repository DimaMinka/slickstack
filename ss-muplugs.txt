#!/bin/bash

####################################################################################################
#### author: SlickStack ############################################################################
#### link: https://slickstack.io ###################################################################
#### mirror: http://mirrors.slickstack.io/ss-muplugs.txt ###########################################
#### path: /var/www/ss-muplugs #####################################################################
#### destination: n/a (not a boilerplate) ##########################################################
#### purpose: Reinstalls various MU (Must-Use) plugins and object cache, etc (idempotent) ##########
#### module version: Ubuntu 18.04 ##################################################################
####################################################################################################

## SLICKSTACK SUPPORTS CUSTOMIZING MU PLUGINS BUT REQUIRES A FEW OF OUR OWN SCRIPTS ##

## include SlickStack configuration ##
source /var/www/ss-config

## critical functions (aliases) for this script to function ##
# apt () { DEBIAN_FRONTEND=noninteractive DEBIAN_PRIORITY=critical PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' /usr/bin/apt -q --yes -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold"; }
# wget () { wget --no-check-certificate --no-cache --no-cookies --tries=3 --timeout=15; }
# cp () { cp -R -f -d --no-preserve=mode,ownership; }
# rm () { rm -R -f; }
# mkdir () { mkdir -p; }

## ensure MU (Must-Use) plugins directory exists ##
mkdir -p /var/www/html/wp-content/mu-plugins

####################################################################################################
#### SS-Muplugs: Delete Any Previous (Leftover) Temporary Files ####################################
####################################################################################################

## delete Autoloader temporary files ##
rm -R -f /tmp/autoloader*

## delete MU (Must-Use) plugins temporary files ##
rm -R -f /tmp/clear-caches*
rm -R -f /tmp/cloudflare*
rm -R -f /tmp/custom-functions*
rm -R -f /tmp/dashboard-cleanup*
rm -R -f /tmp/delete-expired-transients*
rm -R -f /tmp/disable-attachment-pages*
rm -R -f /tmp/disable-embeds*
rm -R -f /tmp/disable-emojis*
rm -R -f /tmp/disable-empty-trash*
rm -R -f /tmp/disable-gutenberg*
rm -R -f /tmp/disable-image-compression*
rm -R -f /tmp/disable-post-via-email*
rm -R -f /tmp/disable-xml-rpc*
rm -R -f /tmp/error-log-monitor*
rm -R -f /tmp/force-https*
rm -R -f /tmp/force-strong-hashing*
rm -R -f /tmp/header-cleanup*
rm -R -f /tmp/index-autoload*
rm -R -f /tmp/limit-heartbeat*
rm -R -f /tmp/maintenance-mode*
rm -R -f /tmp/minify-html*
rm -R -f /tmp/plugin-blacklist*
rm -R -f /tmp/remove-query-strings*
rm -R -f /tmp/server-status*
rm -R -f /tmp/sftp-details*
rm -R -f /tmp/virtual-robotstxt*

## delete XXX Notices (MU plugin) temporary files ##
rm -R -f /tmp/xxx-notices*

## delete object cache temporary files ##
rm -R -f /tmp/object-cache*

## delete Custom Functions temporary files ##
rm -R -f /tmp/functions*

####################################################################################################
#### SS-Muplugs: Install Specified MU (Must-Use) Plugins (Optional) ################################
####################################################################################################

rm -R -f /var/www/html/wp-content/mu-plugins/*

####################################################################################################
#### SS-Muplugs: Install Specified MU (Must-Use) Plugins (Optional) ################################
####################################################################################################

# if [ -n "$MU_PLUGIN_01_SOURCE" ] && [ -n "$MU_PLUGIN_01_DIR" ]; then
# wget -O /tmp/$MU_PLUGIN_01_DIR.zip $MU_PLUGIN_01_SOURCE
# wget -O /tmp/$MU_PLUGIN_02_DIR.zip $MU_PLUGIN_02_SOURCE
# wget -O /tmp/$MU_PLUGIN_03_DIR.zip $MU_PLUGIN_03_SOURCE
# wget -O /tmp/$MU_PLUGIN_04_DIR.zip $MU_PLUGIN_04_SOURCE
# wget -O /tmp/$MU_PLUGIN_05_DIR.zip $MU_PLUGIN_05_SOURCE
# wget -O /tmp/$MU_PLUGIN_06_DIR.zip $MU_PLUGIN_06_SOURCE
# wget -O /tmp/$MU_PLUGIN_07_DIR.zip $MU_PLUGIN_07_SOURCE
# wget -O /tmp/$MU_PLUGIN_08_DIR.zip $MU_PLUGIN_08_SOURCE
# wget -O /tmp/$MU_PLUGIN_09_DIR.zip $MU_PLUGIN_09_SOURCE
# wget -O /tmp/$MU_PLUGIN_10_DIR.zip $MU_PLUGIN_10_SOURCE
# wget -O /tmp/$MU_PLUGIN_11_DIR.zip $MU_PLUGIN_11_SOURCE
# wget -O /tmp/$MU_PLUGIN_12_DIR.zip $MU_PLUGIN_12_SOURCE
# wget -O /tmp/$MU_PLUGIN_13_DIR.zip $MU_PLUGIN_13_SOURCE
# wget -O /tmp/$MU_PLUGIN_14_DIR.zip $MU_PLUGIN_14_SOURCE
# wget -O /tmp/$MU_PLUGIN_15_DIR.zip $MU_PLUGIN_15_SOURCE
# wget -O /tmp/$MU_PLUGIN_16_DIR.zip $MU_PLUGIN_16_SOURCE
# wget -O /tmp/$MU_PLUGIN_17_DIR.zip $MU_PLUGIN_17_SOURCE
# wget -O /tmp/$MU_PLUGIN_18_DIR.zip $MU_PLUGIN_18_SOURCE
# wget -O /tmp/$MU_PLUGIN_19_DIR.zip $MU_PLUGIN_19_SOURCE
# wget -O /tmp/$MU_PLUGIN_20_DIR.zip $MU_PLUGIN_20_SOURCE
# wget -O /tmp/$MU_PLUGIN_21_DIR.zip $MU_PLUGIN_21_SOURCE
# wget -O /tmp/$MU_PLUGIN_22_DIR.zip $MU_PLUGIN_22_SOURCE
# wget -O /tmp/$MU_PLUGIN_23_DIR.zip $MU_PLUGIN_23_SOURCE
# wget -O /tmp/$MU_PLUGIN_24_DIR.zip $MU_PLUGIN_24_SOURCE
# wget -O /tmp/$MU_PLUGIN_25_DIR.zip $MU_PLUGIN_25_SOURCE
# wget -O /tmp/$MU_PLUGIN_26_DIR.zip $MU_PLUGIN_26_SOURCE
# wget -O /tmp/$MU_PLUGIN_27_DIR.zip $MU_PLUGIN_27_SOURCE
# wget -O /tmp/$MU_PLUGIN_28_DIR.zip $MU_PLUGIN_28_SOURCE
# wget -O /tmp/$MU_PLUGIN_29_DIR.zip $MU_PLUGIN_29_SOURCE
# wget -O /tmp/$MU_PLUGIN_30_DIR.zip $MU_PLUGIN_30_SOURCE
# wget -O /tmp/$MU_PLUGIN_31_DIR.zip $MU_PLUGIN_31_SOURCE
# wget -O /tmp/$MU_PLUGIN_32_DIR.zip $MU_PLUGIN_32_SOURCE
# wget -O /tmp/$MU_PLUGIN_33_DIR.zip $MU_PLUGIN_33_SOURCE
# wget -O /tmp/$MU_PLUGIN_34_DIR.zip $MU_PLUGIN_34_SOURCE
# wget -O /tmp/$MU_PLUGIN_35_DIR.zip $MU_PLUGIN_35_SOURCE
# wget -O /tmp/$MU_PLUGIN_36_DIR.zip $MU_PLUGIN_36_SOURCE
# wget -O /tmp/$MU_PLUGIN_37_DIR.zip $MU_PLUGIN_37_SOURCE
# wget -O /tmp/$MU_PLUGIN_38_DIR.zip $MU_PLUGIN_38_SOURCE
# wget -O /tmp/$MU_PLUGIN_39_DIR.zip $MU_PLUGIN_39_SOURCE
# wget -O /tmp/$MU_PLUGIN_40_DIR.zip $MU_PLUGIN_40_SOURCE
# wget -O /tmp/$MU_PLUGIN_41_DIR.zip $MU_PLUGIN_41_SOURCE
# wget -O /tmp/$MU_PLUGIN_42_DIR.zip $MU_PLUGIN_42_SOURCE
# wget -O /tmp/$MU_PLUGIN_43_DIR.zip $MU_PLUGIN_43_SOURCE
# wget -O /tmp/$MU_PLUGIN_44_DIR.zip $MU_PLUGIN_44_SOURCE
# wget -O /tmp/$MU_PLUGIN_45_DIR.zip $MU_PLUGIN_45_SOURCE
# wget -O /tmp/$MU_PLUGIN_46_DIR.zip $MU_PLUGIN_46_SOURCE
# wget -O /tmp/$MU_PLUGIN_47_DIR.zip $MU_PLUGIN_47_SOURCE
# wget -O /tmp/$MU_PLUGIN_48_DIR.zip $MU_PLUGIN_48_SOURCE
# wget -O /tmp/$MU_PLUGIN_49_DIR.zip $MU_PLUGIN_49_SOURCE
# wget -O /tmp/$MU_PLUGIN_50_DIR.zip $MU_PLUGIN_50_SOURCE
# wget -O /tmp/$MU_PLUGIN_51_DIR.zip $MU_PLUGIN_51_SOURCE
# wget -O /tmp/$MU_PLUGIN_52_DIR.zip $MU_PLUGIN_52_SOURCE
# wget -O /tmp/$MU_PLUGIN_53_DIR.zip $MU_PLUGIN_53_SOURCE
# wget -O /tmp/$MU_PLUGIN_54_DIR.zip $MU_PLUGIN_54_SOURCE
# wget -O /tmp/$MU_PLUGIN_55_DIR.zip $MU_PLUGIN_55_SOURCE
# wget -O /tmp/$MU_PLUGIN_56_DIR.zip $MU_PLUGIN_56_SOURCE
# wget -O /tmp/$MU_PLUGIN_57_DIR.zip $MU_PLUGIN_57_SOURCE
# wget -O /tmp/$MU_PLUGIN_58_DIR.zip $MU_PLUGIN_58_SOURCE
# wget -O /tmp/$MU_PLUGIN_59_DIR.zip $MU_PLUGIN_59_SOURCE
# wget -O /tmp/$MU_PLUGIN_60_DIR.zip $MU_PLUGIN_60_SOURCE
# wget -O /tmp/$MU_PLUGIN_61_DIR.zip $MU_PLUGIN_61_SOURCE
# wget -O /tmp/$MU_PLUGIN_62_DIR.zip $MU_PLUGIN_62_SOURCE
# wget -O /tmp/$MU_PLUGIN_63_DIR.zip $MU_PLUGIN_63_SOURCE
# wget -O /tmp/$MU_PLUGIN_64_DIR.zip $MU_PLUGIN_64_SOURCE
# wget -O /tmp/$MU_PLUGIN_65_DIR.zip $MU_PLUGIN_65_SOURCE
# wget -O /tmp/$MU_PLUGIN_66_DIR.zip $MU_PLUGIN_66_SOURCE
# wget -O /tmp/$MU_PLUGIN_67_DIR.zip $MU_PLUGIN_67_SOURCE
# wget -O /tmp/$MU_PLUGIN_68_DIR.zip $MU_PLUGIN_68_SOURCE
# wget -O /tmp/$MU_PLUGIN_69_DIR.zip $MU_PLUGIN_69_SOURCE
# wget -O /tmp/$MU_PLUGIN_70_DIR.zip $MU_PLUGIN_70_SOURCE
# wget -O /tmp/$MU_PLUGIN_71_DIR.zip $MU_PLUGIN_71_SOURCE
# wget -O /tmp/$MU_PLUGIN_72_DIR.zip $MU_PLUGIN_72_SOURCE
# wget -O /tmp/$MU_PLUGIN_73_DIR.zip $MU_PLUGIN_73_SOURCE
# wget -O /tmp/$MU_PLUGIN_74_DIR.zip $MU_PLUGIN_74_SOURCE
# wget -O /tmp/$MU_PLUGIN_75_DIR.zip $MU_PLUGIN_75_SOURCE
# wget -O /tmp/$MU_PLUGIN_76_DIR.zip $MU_PLUGIN_76_SOURCE
# wget -O /tmp/$MU_PLUGIN_77_DIR.zip $MU_PLUGIN_77_SOURCE
# wget -O /tmp/$MU_PLUGIN_78_DIR.zip $MU_PLUGIN_78_SOURCE
# wget -O /tmp/$MU_PLUGIN_79_DIR.zip $MU_PLUGIN_79_SOURCE
# wget -O /tmp/$MU_PLUGIN_80_DIR.zip $MU_PLUGIN_80_SOURCE
# wget -O /tmp/$MU_PLUGIN_81_DIR.zip $MU_PLUGIN_81_SOURCE
# wget -O /tmp/$MU_PLUGIN_82_DIR.zip $MU_PLUGIN_82_SOURCE
# wget -O /tmp/$MU_PLUGIN_83_DIR.zip $MU_PLUGIN_83_SOURCE
# wget -O /tmp/$MU_PLUGIN_84_DIR.zip $MU_PLUGIN_84_SOURCE
# wget -O /tmp/$MU_PLUGIN_85_DIR.zip $MU_PLUGIN_85_SOURCE
# wget -O /tmp/$MU_PLUGIN_86_DIR.zip $MU_PLUGIN_86_SOURCE
# wget -O /tmp/$MU_PLUGIN_87_DIR.zip $MU_PLUGIN_87_SOURCE
# wget -O /tmp/$MU_PLUGIN_88_DIR.zip $MU_PLUGIN_88_SOURCE
# wget -O /tmp/$MU_PLUGIN_89_DIR.zip $MU_PLUGIN_89_SOURCE
# wget -O /tmp/$MU_PLUGIN_90_DIR.zip $MU_PLUGIN_90_SOURCE
# wget -O /tmp/$MU_PLUGIN_91_DIR.zip $MU_PLUGIN_91_SOURCE
# wget -O /tmp/$MU_PLUGIN_92_DIR.zip $MU_PLUGIN_92_SOURCE
# wget -O /tmp/$MU_PLUGIN_93_DIR.zip $MU_PLUGIN_93_SOURCE
# wget -O /tmp/$MU_PLUGIN_94_DIR.zip $MU_PLUGIN_94_SOURCE
# wget -O /tmp/$MU_PLUGIN_95_DIR.zip $MU_PLUGIN_95_SOURCE
# wget -O /tmp/$MU_PLUGIN_96_DIR.zip $MU_PLUGIN_96_SOURCE
# wget -O /tmp/$MU_PLUGIN_97_DIR.zip $MU_PLUGIN_97_SOURCE
# wget -O /tmp/$MU_PLUGIN_98_DIR.zip $MU_PLUGIN_98_SOURCE
# wget -O /tmp/$MU_PLUGIN_99_DIR.zip $MU_PLUGIN_99_SOURCE 
# else

####################################################################################################
#### SS-Muplugs: Install Specified MU (Must-Use) Plugins (Optional) ################################
####################################################################################################

## wget them all ##
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/clear-caches.zip http://mirrors.slickstack.io/mu-plugins/clear-caches.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/cloudflare.zip http://mirrors.slickstack.io/mu-plugins/cloudflare.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/dashboard-cleanup.zip http://mirrors.slickstack.io/mu-plugins/dashboard-cleanup.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/delete-expired-transients.zip http://mirrors.slickstack.io/mu-plugins/delete-expired-transients.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/disable-attachment-pages.zip http://mirrors.slickstack.io/mu-plugins/disable-attachment-pages.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/disable-embeds.zip http://mirrors.slickstack.io/mu-plugins/disable-embeds.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/disable-emojis.zip http://mirrors.slickstack.io/mu-plugins/disable-emojis.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/disable-empty-trash.zip http://mirrors.slickstack.io/mu-plugins/disable-empty-trash.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/disable-gutenberg.zip http://mirrors.slickstack.io/mu-plugins/disable-gutenberg.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/disable-image-compression.zip http://mirrors.slickstack.io/mu-plugins/disable-image-compression.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/disable-post-via-email.zip http://mirrors.slickstack.io/mu-plugins/disable-post-via-email.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/disable-xml-rpc.zip http://mirrors.slickstack.io/mu-plugins/disable-xml-rpc.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/error-log-monitor.zip http://mirrors.slickstack.io/mu-plugins/error-log-monitor.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/force-https.zip http://mirrors.slickstack.io/mu-plugins/force-https.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/force-strong-hashing.zip http://mirrors.slickstack.io/mu-plugins/force-strong-hashing.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/header-cleanup.zip http://mirrors.slickstack.io/mu-plugins/header-cleanup.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/index-autoload.zip http://mirrors.slickstack.io/mu-plugins/index-autoload.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/limit-heartbeat.zip http://mirrors.slickstack.io/mu-plugins/limit-heartbeat.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/maintenance-mode.zip http://mirrors.slickstack.io/mu-plugins/maintenance-mode.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/minify-html.zip http://mirrors.slickstack.io/mu-plugins/minify-html.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/plugin-blacklist.zip http://mirrors.slickstack.io/mu-plugins/plugin-blacklist.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/server-status.zip http://mirrors.slickstack.io/mu-plugins/server-status.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/sftp-details.zip http://mirrors.slickstack.io/mu-plugins/sftp-details.zip
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/virtual-robotstxt.zip http://mirrors.slickstack.io/mu-plugins/virtual-robotstxt.zip

## unzip them all ##
unzip /tmp/clear-caches.zip -d /tmp
unzip /tmp/cloudflare.zip -d /tmp
unzip /tmp/dashboard-cleanup.zip -d /tmp
unzip /tmp/delete-expired-transients.zip -d /tmp
unzip /tmp/disable-attachment-pages.zip -d /tmp
unzip /tmp/disable-embeds.zip -d /tmp
unzip /tmp/disable-emojis.zip -d /tmp
unzip /tmp/disable-empty-trash.zip -d /tmp
unzip /tmp/disable-gutenberg.zip -d /tmp
unzip /tmp/disable-image-compression.zip -d /tmp
unzip /tmp/disable-post-via-email.zip -d /tmp
unzip /tmp/disable-xml-rpc.zip -d /tmp
unzip /tmp/error-log-monitor.zip -d /tmp
unzip /tmp/force-https.zip -d /tmp
unzip /tmp/force-strong-hashing.zip -d /tmp
unzip /tmp/header-cleanup.zip -d /tmp
unzip /tmp/index-autoload.zip -d /tmp
unzip /tmp/limit-heartbeat.zip -d /tmp
unzip /tmp/maintenance-mode.zip -d /tmp
unzip /tmp/minify-html.zip -d /tmp
unzip /tmp/plugin-blacklist.zip -d /tmp
unzip /tmp/server-status.zip -d /tmp
unzip /tmp/sftp-details.zip -d /tmp
unzip /tmp/virtual-robotstxt.zip -d /tmp

## delete plugins instances (conflicting namespaces or previous namespaces) ##
rm -R -f /var/www/html/wp-content/plugins/clear-caches*
rm -R -f /var/www/html/wp-content/plugins/cloudflare*
rm -R -f /var/www/html/wp-content/plugins/cf-littlebizzy* ## previous CloudFlare namespace
rm -R -f /var/www/html/wp-content/plugins/dashboard-cleanup*
rm -R -f /var/www/html/wp-content/plugins/delete-expired-transients*
rm -R -f /var/www/html/wp-content/plugins/disable-attachment-pages*
rm -R -f /var/www/html/wp-content/plugins/disable-embeds*
rm -R -f /var/www/html/wp-content/plugins/disable-emojis*
rm -R -f /var/www/html/wp-content/plugins/disable-empty-trash*
rm -R -f /var/www/html/wp-content/plugins/disable-gutenberg*
rm -R -f /var/www/html/wp-content/plugins/disable-image-compression*
rm -R -f /var/www/html/wp-content/plugins/disable-post-via-email*
rm -R -f /var/www/html/wp-content/plugins/disable-xml-rpc*
rm -R -f /var/www/html/wp-content/plugins/error-log-monitor*
rm -R -f /var/www/html/wp-content/plugins/force-https*
rm -R -f /var/www/html/wp-content/plugins/force-strong-hashing*
rm -R -f /var/www/html/wp-content/plugins/header-cleanup*
rm -R -f /var/www/html/wp-content/plugins/index-autoload*
rm -R -f /var/www/html/wp-content/plugins/limit-heartbeat*
rm -R -f /var/www/html/wp-content/plugins/maintenance-mode*
rm -R -f /var/www/html/wp-content/plugins/minify-html*
rm -R -f /var/www/html/wp-content/plugins/plugin-blacklist*
rm -R -f /var/www/html/wp-content/plugins/purge-them-all* ## previous Clear Caches namespace
rm -R -f /var/www/html/wp-content/plugins/remove-query-strings*
rm -R -f /var/www/html/wp-content/plugins/server-status*
rm -R -f /var/www/html/wp-content/plugins/sftp-details*
rm -R -f /var/www/html/wp-content/plugins/virtual-robotstxt*

## copy to destination ##
cp -R -f -d --no-preserve=mode,ownership /tmp/clear-caches /var/www/html/wp-content/mu-plugins/clear-caches
cp -R -f -d --no-preserve=mode,ownership /tmp/cloudflare /var/www/html/wp-content/mu-plugins/cloudflare
cp -R -f -d --no-preserve=mode,ownership /tmp/dashboard-cleanup /var/www/html/wp-content/mu-plugins/dashboard-cleanup
cp -R -f -d --no-preserve=mode,ownership /tmp/delete-expired-transients /var/www/html/wp-content/mu-plugins/delete-expired-transients
cp -R -f -d --no-preserve=mode,ownership /tmp/disable-attachment-pages /var/www/html/wp-content/mu-plugins/disable-attachment-pages
cp -R -f -d --no-preserve=mode,ownership /tmp/disable-embeds /var/www/html/wp-content/mu-plugins/disable-embeds
cp -R -f -d --no-preserve=mode,ownership /tmp/disable-emojis /var/www/html/wp-content/mu-plugins/disable-emojis
cp -R -f -d --no-preserve=mode,ownership /tmp/disable-empty-trash /var/www/html/wp-content/mu-plugins/disable-empty-trash
cp -R -f -d --no-preserve=mode,ownership /tmp/disable-gutenberg /var/www/html/wp-content/mu-plugins/disable-gutenberg
cp -R -f -d --no-preserve=mode,ownership /tmp/disable-image-compression /var/www/html/wp-content/mu-plugins/disable-image-compression
cp -R -f -d --no-preserve=mode,ownership /tmp/disable-post-via-email /var/www/html/wp-content/mu-plugins/disable-post-via-email
cp -R -f -d --no-preserve=mode,ownership /tmp/disable-xml-rpc /var/www/html/wp-content/mu-plugins/disable-xml-rpc
cp -R -f -d --no-preserve=mode,ownership /tmp/error-log-monitor /var/www/html/wp-content/mu-plugins/error-log-monitor
cp -R -f -d --no-preserve=mode,ownership /tmp/force-https /var/www/html/wp-content/mu-plugins/force-https
cp -R -f -d --no-preserve=mode,ownership /tmp/force-strong-hashing /var/www/html/wp-content/mu-plugins/force-strong-hashing
cp -R -f -d --no-preserve=mode,ownership /tmp/header-cleanup /var/www/html/wp-content/mu-plugins/header-cleanup
cp -R -f -d --no-preserve=mode,ownership /tmp/index-autoload /var/www/html/wp-content/mu-plugins/index-autoload
cp -R -f -d --no-preserve=mode,ownership /tmp/limit-heartbeat /var/www/html/wp-content/mu-plugins/limit-heartbeat
cp -R -f -d --no-preserve=mode,ownership /tmp/maintenance-mode /var/www/html/wp-content/mu-plugins/maintenance-mode
cp -R -f -d --no-preserve=mode,ownership /tmp/minify-html /var/www/html/wp-content/mu-plugins/minify-html
cp -R -f -d --no-preserve=mode,ownership /tmp/plugin-blacklist /var/www/html/wp-content/mu-plugins/plugin-blacklist
cp -R -f -d --no-preserve=mode,ownership /tmp/server-status /var/www/html/wp-content/mu-plugins/server-status
cp -R -f -d --no-preserve=mode,ownership /tmp/sftp-details /var/www/html/wp-content/mu-plugins/sftp-details
cp -R -f -d --no-preserve=mode,ownership /tmp/virtual-robotstxt /var/www/html/wp-content/mu-plugins/virtual-robotstxt

## end if ##
# fi

####################################################################################################
#### SS-Muplugs: Install Autoloader, XXX Notices, And Object Cache (Required) ######################
####################################################################################################

## download latest files ##
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/autoloader.php http://mirrors.slickstack.io/mu-plugins/autoloader.txt
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/xxx-notices.php http://mirrors.slickstack.io/mu-plugins/xxx-notices.txt
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/object-cache.php http://mirrors.slickstack.io/wordpress/object-cache.txt
wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/custom-functions.zip http://mirrors.slickstack.io/mu-plugins/custom-functions.zip

## unzip files ##
unzip /tmp/custom-functions.zip -d /tmp

## delete potentially conflicting plugins ##
rm -R -f /var/www/html/wp-content/plugins/autoloader*
rm -R -f /var/www/html/wp-content/plugins/xxx-notices*
rm -R -f /var/www/html/wp-content/plugins/redis*
rm -R -f /var/www/html/wp-content/plugins/object-cache*
rm -R -f /var/www/html/wp-content/object-cache*
rm -R -f /var/www/html/wp-content/mu-plugins/custom-functions*
# rm -R -f /var/www/html/wp-content/plugins/custom-functions* ## don't delete others until ours is working 100% perfect

## copy files to destinations ##
cp -R -f -d --no-preserve=mode,ownership /tmp/autoloader.php /var/www/html/wp-content/mu-plugins/autoloader.php
cp -R -f -d --no-preserve=mode,ownership /tmp/xxx-notices.php /var/www/html/wp-content/mu-plugins/xxx-notices.php
cp -R -f -d --no-preserve=mode,ownership /tmp/object-cache.php /var/www/html/wp-content/object-cache.php
cp -R -f -d --no-preserve=mode,ownership /tmp/custom-functions /var/www/html/wp-content/mu-plugins/custom-functions

####################################################################################################
#### SS-Muplugs: Configure Custom Functions (MU) Plugin (Required) #################################
####################################################################################################

## download specified functions file (otherwise create generic) if none exists ##
if [ ! -f /var/www/html/wp-content/functions.php ] && [ -z "$CUSTOM_FUNCTIONS_SOURCE" ]; then
    wget --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/functions.php http://mirrors.slickstack.io/wordpress/functions.txt
elif [ ! -f /var/www/html/wp-content/functions.php ] && [ -n "$CUSTOM_FUNCTIONS_SOURCE" ]; then
    wget --no-check-certificate --no-cache --no-cookies --tries=3 --timeout=15 -O /tmp/functions.php "$CUSTOM_FUNCTIONS_SOURCE"
fi

## copy files to destinations ##
cp -R -f --no-preserve=mode,ownership /tmp/functions.php /var/www/html/wp-content/functions.php

####################################################################################################
#### SS-Muplugs: Reset Permissions #################################################################
####################################################################################################

chown -R www-data:wordpress /var/www/html/wp-content/mu-plugins
chown -R www-data:wordpress /var/www/html/wp-content/object-cache.php
chown $SFTP_USER:wordpress /var/www/html/wp-content/functions.php
find /var/www/html/wp-content/mu-plugins/ -type d -exec chmod 775 {} \;
find /var/www/html/wp-content/mu-plugins/ -type f -exec chmod 664 {} \;
chmod 664 /var/www/html/wp-content/object-cache.php
chmod 6775 /var/www/html/wp-content/functions.php

####################################################################################################
#### SS-Muplugs: Delete Any Previous (Leftover) Temporary Files ####################################
####################################################################################################

## delete Autoloader temporary files ##
rm -R -f /tmp/autoloader*

## delete MU (Must-Use) plugins temporary files ##
rm -R -f /tmp/clear-caches*
rm -R -f /tmp/cloudflare*
rm -R -f /tmp/custom-functions*
rm -R -f /tmp/dashboard-cleanup*
rm -R -f /tmp/delete-expired-transients*
rm -R -f /tmp/disable-attachment-pages*
rm -R -f /tmp/disable-embeds*
rm -R -f /tmp/disable-emojis*
rm -R -f /tmp/disable-empty-trash*
rm -R -f /tmp/disable-gutenberg*
rm -R -f /tmp/disable-image-compression*
rm -R -f /tmp/disable-post-via-email*
rm -R -f /tmp/disable-xml-rpc*
rm -R -f /tmp/error-log-monitor*
rm -R -f /tmp/force-https*
rm -R -f /tmp/force-strong-hashing*
rm -R -f /tmp/header-cleanup*
rm -R -f /tmp/index-autoload*
rm -R -f /tmp/limit-heartbeat*
rm -R -f /tmp/maintenance-mode*
rm -R -f /tmp/minify-html*
rm -R -f /tmp/plugin-blacklist*
rm -R -f /tmp/remove-query-strings*
rm -R -f /tmp/server-status*
rm -R -f /tmp/sftp-details*
rm -R -f /tmp/virtual-robotstxt*

## delete XXX Notices (MU plugin) temporary files ##
rm -R -f /tmp/xxx-notices*

## delete object cache temporary files ##
rm -R -f /tmp/object-cache*

## delete Custom Functions temporary files ##
rm -R -f /tmp/functions*

####################################################################################################
#### SS-Muplugs: Reset PHP OPcache + Flush Redis Object Cache ######################################
####################################################################################################

## reset PHP OPcache ##
RANDOM_RESET_OPCACHE=$(openssl rand -hex 48)
echo "<?php opcache_reset(); ?>" > /var/www/html/${RANDOM_RESET_OPCACHE}.php
/usr/bin/php /var/www/html/${RANDOM_RESET_OPCACHE}.php
rm /var/www/html/${RANDOM_RESET_OPCACHE}.php

## flush Redis cache (object cache) ##
redis-cli flushall &> /dev/null

####################################################################################################
#### External References Used By SlickStack To Improve This Script #################################
####################################################################################################

## Ref: 
