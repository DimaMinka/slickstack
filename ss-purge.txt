#!/bin/bash

####################################################################################################
#### author: SlickStack ############################################################################
#### link: https://slickstack.io ###################################################################
#### mirror: http://mirrors.slickstack.io/ss-purge.txt #############################################
#### path: /var/www/ss-purge #######################################################################
#### destination: n/a (not a boilerplate) ##########################################################
#### purpose: clears all caches including FastCGI, OPcache, and Redis (object cache) ###############
#### module version: n/a ###########################################################################
####################################################################################################

## include SlickStack configuration ##
source /var/www/ss-config

## critical functions (aliases) ##
# rm () { rm -R -f; }
# wget () { wget --no-cache --no-cookies --tries=3 --timeout=15; }
# cp () { cp -R -f -d --no-preserve=mode,ownership; }
# mkdir () { mkdir -p; }

####################################################################################################
### SS-Purge: Clear Nginx FastCGI Cache (Deletes All Cache Files On Disk / TMPFS) ##################
####################################################################################################

rm -R -f /var/www/cache/*

####################################################################################################
#### Reset PHP OPcache (Bash Script Workaround) ####################################################
####################################################################################################

RANDOM_RESET_OPCACHE=$(openssl rand -hex 48)
echo "<?php opcache_reset(); ?>" > /var/www/html/${RANDOM_RESET_OPCACHE}.php
/usr/bin/php /var/www/html/${RANDOM_RESET_OPCACHE}.php
rm /var/www/html/${RANDOM_RESET_OPCACHE}.php

####################################################################################################
#### Flush Redis (Object Cache) ####################################################################
####################################################################################################

redis-cli flushall

####################################################################################################
#### External References Used By SlickStack To Improve This Script #################################
####################################################################################################

## Ref: https://www.php.net/manual/en/function.opcache-reset.php#121513
## Ref: https://stackoverflow.com/questions/5506913/bash-script-to-run-php-script
